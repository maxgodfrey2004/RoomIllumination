<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Room Illumination</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
    }
  </style>
</head>
<body>
  <h1>Room Illumination Demonstration</h1>
  <button id="drawButton" onclick="startAnimation()">Start</button>
  <button id="stopButton" onclick="stopAnimation()">Stop</button>
  <br/>
  <br/>
  <canvas id="canvas" width="800" height="800" style="border: 1px solid black;"/>
  <script src="classes.js"></script>
  <script>
    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
    
    const NUM_COLLISIONS_BEFORE_TERMINATION = 100;
    
    const ORIGIN = [300, 300];
    
    const COORDS = [
      [300, 100],
      [400, 200],
      [400, 300],
      [500, 300],
      [500, 400],
      [600, 400],
      [700, 500],
      [600, 500],
      [600, 600],
      [500, 700],
      [500, 600],
      [400, 600],
      [300, 500],
      [400, 500],
      [400, 400],
      [300, 500],
      [300, 400],
      [200, 400],
      [200, 300],
      [100, 300],
      [200, 200],
      [300, 200],
    ];

    var boundaries = new Array();
    var photons = new Array();
    var renderInterval;

    function loadBoundaries() {
      boundaries = new Array();
      for (var i = 0; i < COORDS.length; ++i) {
        nxtIdx = (i + 1) % COORDS.length;
        boundaries.push(new LineSegment(
          COORDS[i][0],
          COORDS[i][1],
          COORDS[nxtIdx][0],
          COORDS[nxtIdx][1]
        ));
      }
    }
    
    function createPhotons() {
      photons = new Array();
      // Testing photons:
      // photons.push(new Photon(ORIGIN[0], ORIGIN[1], 0.349, 0.3, 0.151));
      // photons.push(new Photon(ORIGIN[0], ORIGIN[1], -0.349, 0.3, 0.151));
      for (var i = 0; i <= 255; ++i) {
        photons.push(new Photon(
          ORIGIN[0],
          ORIGIN[1],
          (i / 256) * 2 * Math.PI,
          0.151,
          0.151,
          `rgb(${i}, 153, 255)`,
        ));
      }
    }

    function drawCircle(x, y, radius, color = 'black') {
      ctx.beginPath();
      ctx.fillStyle = color; 
      ctx.arc(x, y, radius, 0, 2 * Math.PI);
      ctx.fill();
    }

    function drawLine(x1, y1, x2, y2, color = 'black', width = 0.5) {
      ctx.beginPath();
      ctx.strokeStyle = color;
      ctx.lineWidth = width;
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.stroke();
    }

    function drawBackground() {
      ctx.beginPath();
      ctx.fillStyle = 'black';
      ctx.rect(0, 0, 800, 800);
      ctx.fill();
    }

    function drawPolygon() {
      for (var i = 0; i < COORDS.length; ++i) {
        var nxtIdx = (i + 1) % COORDS.length;
        drawLine(COORDS[i][0], COORDS[i][1], COORDS[nxtIdx][0],
            COORDS[nxtIdx][1],'white', 10);
        drawCircle(COORDS[i][0], COORDS[i][1], 5, 'white');
      }
      ctx.beginPath();
      ctx.fillStyle = 'black';
      ctx.moveTo(COORDS[0][0], COORDS[0][1]);
      for (var i = 0; i < COORDS.length; ++i) {
        nxtIdx = (i + 1) % COORDS.length;
        ctx.lineTo(COORDS[nxtIdx][0], COORDS[nxtIdx][1]);
      }
      ctx.closePath();
      ctx.fill();
    }

    function drawPointsOfInterest() {
      drawCircle(ORIGIN[0], ORIGIN[1], 2, 'green');
    }

    function drawPhotons() {
      for (var i = 0; i < photons.length; ++i) {
        const len = photons[i].contactPoints.length;
        for (var j = 0; j < len - 1; ++j) {
          drawLine(
            photons[i].contactPoints[j][0],
            photons[i].contactPoints[j][1],
            photons[i].contactPoints[j + 1][0],
            photons[i].contactPoints[j + 1][1],
            photons[i].color
          );
        }
        drawLine(
          photons[i].contactPoints[len - 1][0],
          photons[i].contactPoints[len - 1][1],
          photons[i].x,
          photons[i].y,
          photons[i].color
        );
      }
      for (var i = 0; i < photons.length; ++i) {
        drawCircle(photons[i].x, photons[i].y, 1.3, photons[i].color);
      }
    }

    function draw() {
      drawBackground();
      drawPolygon();
      drawPointsOfInterest();
      drawPhotons();
    }

    function updatePositions() {
      for (var i = photons.length - 1; i >= 0; --i) {
        for (var edge = 0; edge < boundaries.length; ++edge) {
          if (edge !== photons[i].lastBounce &&
              photons[i].checkLineCollision(boundaries[edge])) {
            photons[i].lastBounce = edge;
            photons[i].bounceOffSegment(boundaries[edge]);
            hasBounced = true;
            break;
          }
        }
      }
      for (var i = 0; i < photons.length; ++i) {
        photons[i].updatePosition();
      }
    }

    function updateScreen() {
      for (var i = 0; i < 10; ++i) {
        updatePositions();
      }
      draw();
    }

    function startAnimation() {
      clearInterval(renderInterval);
      loadBoundaries();
      createPhotons();
      renderInterval = setInterval(updateScreen, 30);
    }

    function stopAnimation() {
      clearInterval(renderInterval);
    }
  </script>
</body>
</html>